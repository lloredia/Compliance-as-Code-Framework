#Compliance Scan Workflow
name: Compliance Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        working-directory: ./terraform/live
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: ./terraform/live
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: ./terraform/live
        run: terraform validate

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Prowler
        run: |
          pip install prowler
          prowler -v

      - name: Run Prowler Compliance Scan
        run: |
          prowler aws \
            --compliance cis_1.5_aws \
            --output-formats json csv html \
            --output-directory ./prowler-reports
        continue-on-error: true

      - name: Upload Prowler Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: prowler-reports
          path: ./prowler-reports/
          retention-days: 30

      - name: Analyze Prowler Results
        run: |
          python3 << 'EOF'
          import json
          import sys
          
          # Find the JSON report
          import os
          import glob
          
          json_files = glob.glob('./prowler-reports/*.json')
          if not json_files:
              print("No JSON report found")
              sys.exit(0)
          
          with open(json_files[0], 'r') as f:
              findings = json.load(f)
          
          # Count by severity
          critical = sum(1 for f in findings if f.get('Status') == 'FAIL' and f.get('Severity') == 'critical')
          high = sum(1 for f in findings if f.get('Status') == 'FAIL' and f.get('Severity') == 'high')
          medium = sum(1 for f in findings if f.get('Status') == 'FAIL' and f.get('Severity') == 'medium')
          low = sum(1 for f in findings if f.get('Status') == 'FAIL' and f.get('Severity') == 'low')
          passed = sum(1 for f in findings if f.get('Status') == 'PASS')
          
          print(f"\n=== COMPLIANCE SCAN RESULTS ===")
          print(f"‚úÖ PASSED: {passed}")
          print(f"üî¥ CRITICAL: {critical}")
          print(f"üü† HIGH: {high}")
          print(f"üü° MEDIUM: {medium}")
          print(f"üîµ LOW: {low}")
          
          # Fail the build if critical or high severity issues found
          if critical > 0:
              print(f"\n‚ùå FAILED: {critical} critical severity findings detected!")
              sys.exit(1)
          
          if high > 10:
              print(f"\n‚ö†Ô∏è  WARNING: {high} high severity findings detected (threshold: 10)")
              # Uncomment to fail on high severity issues
              # sys.exit(1)
          
          print(f"\n‚úÖ Compliance check passed!")
          EOF

  checkov-scan:
    name: Checkov IaC Scan
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          output_format: cli,sarif
          output_file_path: console,results.sarif
          soft_fail: true

      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [security-scan, checkov-scan]
    if: github.event_name == 'pull_request'
    
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ./terraform/live
        run: terraform init

      - name: Terraform Plan
        working-directory: ./terraform/live
        run: terraform plan -out=tfplan

      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('./terraform/live/tfplan', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Terraform Plan\n```\n' + plan + '\n```'
            });
